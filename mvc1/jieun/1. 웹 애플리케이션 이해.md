# 웹 서버, 웹 애플리케이션 서버

클라이언트가 서버로 데이터를 전송할 때, 서버가 클라이언트로 데이터를 응답할 때 HTTP 프로토콜을 기반으로 동작한다.

## 모든 것이 HTTP

HTTP 메시지에 모든 것을 전송할 수 있다.

- HTML, TEXT
- IMAGE, 음성, 영상, 파일
- JSON, XML (API)
- 거의 모든 형태의 데이터
- 서버 간에 데이터를 주고 받을 떄도 대부분 HTTP 사용

## 웹 서버 (Web Server)

- HTTP 기반으로 동작
- 정적 리소스 제공
    - HTML을 사용자마다 다르게 보여줄 수 없음
    - HTML, CSS, JS, 이미지 영상
- 예) NGINX, APACHE

## 웹 애플리케이션 서버 (WAS - Web Application Server)

- HTTP 기반으로 동작
- 웹 서버 기능 포함 (정적 리소스 제공 가능)
- 프로그램 코드를 실행해서 애플리케이션 로직 수행
    - 동적 HTML, HTTP API(JSON)
    - 서블릿, JSP, 스프링, MVC
    - 사용자에 따라서 다른 화면 보여주기 가능
- 예) Tomcat, Jetty, Undertow

## 웹 서버, 웹 애플리케이션 서버 차이

- 웹 서버는 정적 리소스만, WAS는 애플리케이션 로직까지 실행이 가능하다.
- 웹 서버도 프로그램을 실행하는 기능을 포함하기도 한다.
- WAS가 애플리케이션 코드를 실행하는데 더 특화되었다.

## 기본적인 웹 시스템 구성

- WAS, DB 만으로 시스템 구성이 가능하다.
    - 최소한으로 본다면 WAS와 DB로 구성
- WAS는 정적 리소스, 애플리케이션 로직 모두 제공 가능하다.
- WAS가 너무 많은 역할을 담당하면 서버 과부하 우려가 생긴다.
    - 정적 리소스 제공, 애플리케이션 로직 수행 ...
- 가장 비싼 애플리케이션 로직이 정적 리소스때문에 수행이 어려울 수 있다.
- WAS 장애 시 웹 브라우저가 접근 조차 할 수 없기 때문에 오류 화면 노출이 불가능하다.

## 일반적인 웹 시스템 구성

- WEB Server, WAS, DB로 구성하여 업무를 분담한다.
- 정적 리소스는 웹 서버가 처리한다.
- 웹 서버는 동적인 처리가 필요하면 WAS에 요청을 위임한다.
    - 애플리케이션 로직
- WAS는 애플리케이션 로직 처리를 전담한다.
- 효율적인 리소스 관리가 가능하다.
    - 정적 리소스가 많이 사용되면 웹 서버 증설
    - 애플리케이션 리소스가 많이 사용되면 WAS 증설
- WAS, DB 장애 시 웹 서버가 오류 화면을 제공할 수 있다.
    - 오류 화면 HTML

> **CDN(Content Delivery Network)**
>
> 지리적으로 분산된 서버들을 연결한 네트워크로서 웹 컨텐츠의 복사본을 사용자에 가까운 곳에 두거나 동적 컨텐츠의 전달을 활성화하여 웹 성능 및 속도를
> 향상할 수 있게 합니다.

> API만 제공한다면 웹 서버가 필요 없다. WAS만 구축하면 된다.

# 서블릿

## HTML Form 데이터 전송 (POST)

```html

<form action="/save" method="post">
  <input name="username"/>
  <input name="age"/>
  <button type="submit">전송</button>
</form>
```

```
// 웹 브라우저가 생성한 요청 HTTP 메시지
POST /save HTTP/1.1
Host: localhost:8080
Content-Type: application/x-ww-form-urlencoded

username=kim&age=20
```

## 서블릿 시용 X, 웹 애플리케이션 서버 직접 구현

- 서버 TCP/IP 연결 대기, 소켓 연결
- HTTP 요청 메시지를 파싱해서 읽기
- POST 방식, /save URL 확인
- Content-Type 확인
- HTTP 메시지 바디 내용 피싱
    - username, age 데이터 파싱
- 저장 프로세스 실행
- 비즈니스 로직 실행
    - 데이터베이스에 저장 요청
- HTTP 응답 메시지 생성 시작
    - HTTP 시작 라인 생성
    - Header 생성
    - 메시지 바디에 HTML 입력
- TCP/IP에 응답 전달, 소켓 종료

## 서블릿을 지원하는 WAS 사용

- 비즈니스 로직 실행
    - 데이터베이스에 저장 요청
- 직접 구현했던 다른 일은 다 자동화

## 서블릿 특징

- `urlPatterns`의 URL이 호출되면 서블릿 코드가 실행된다.
- HTTP 요청 정보를 편리하게 사용할 수 있는 `HttpServletRequest`를 제공한다.
    - 비즈니스 로직 전
- HTTP 응답 정보를 편리하게 사용할 수 있는 `HttpServletResponse`를 제공한다.
    - 비즈니스 로직 후
- HTTP 스펙을 매우 편리하게 사용할 수 있도록 도와준다.

## HTTP 요청 시 흐름

- WAS는 request, response 객체를 새로 만들어서 서블릿 객체를 호출한다.
- 개발자는 request 객체에서 HTTP 요청 정보를 편리하게 꺼내서 사용 가능하다.
- 개발자는 response 객체에 응답 정보를 편리하게 입력 가능하다.
- WAS는 response 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성한다.

## 서블릿 컨테이너

- 톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 한다.
- 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기를 관리한다.
- 서블릿 객체는 싱글톤으로 관리된다.
    - 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
    - 모든 고객 요청은 동일한 서블릿 객체 인스턴스에 접근
    - 공유 변수 사용 주의
    - 서블릿 컨테이너 종료 시 함꼐 종료
- JSP도 서블릿으로 변환되어서 사용된다.
- 동시 요청을 위한 멀티 쓰레드 처리를 지원한다.

# 동시요청 - 멀티 쓰레드

## 쓰레드

- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드다.
- 자바 메인 메서드를 처음 실행하면 `main`이라는 이름의 쓰레드가 실행된다.
- 쓰레드가 없다면 자바 애플리케이션 실행이 불가능하다.
- 쓰레드는 한 번에 하나의 코드 라인만 수행한다.
- 동시 처리가 필요하면 쓰레드를 추가로 생성해야 한다.

## 요청 마다 쓰레드 생성

### 장점

- 동시 요청을 처리할 수 있다.
- 리소스가 허용할 때까지 처리가 가능하다.
- 하나의 쓰레드가 지연되는 것과 상관없이 나머지 쓰레드는 정상적으로 동작한다.

### 단점

- 쓰레드 생성 비용이 매우 비싸다
    - 고객의 요청마다 쓰레드를 생성하면 응답 속도가 늦어짐
- 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
    - 쓰레드가 많아질수록 그 비용도 커짐
- 쓰레드 생성에 제한이 없다.
    - 고객 요청이 너무 많으면 CPU, 메모리 임계점을 넘어서 서버 죽을 수 있음

## 쓰레드 풀

### 특징

- 요청마다 쓰레드 생성하는 것의 단점을 보완한다.
- 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
- 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다.
    - 톰캣의 기본 설정은 200개

### 사용

- 쓰레드가 필요하면 이미 생성되어있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.
- 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다
    - 쓰레드 종료가 아님
- 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없다면 추가 요청은 거절하거나, 특정 숫자만큼 대기하도록 설정 가능하다.

### 장점

- 쓰레드가 미리 생성되어 있으므로 쓰레드를 생성하고 종료하는 비용이 절약되고, 응답시간이 빠르다.
- 생성하 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 안전하게 처리 가능하다.

### 실무 팁

- WAS의 주요 튜닝 포인트는 최대 쓰레드 수 이다.
- 너무 낮게 설정하면 동시 요청이 많은 경우, 클라이언트의 응답 지연을 유발할 수 있다.
- 너무 높게 설정하면 동시 요청이 많은 경우, CPU 메로리 리소스 임계점 초과로 서버가 다운될 수 있다.
- 클라우드의 경우 장애가 발생하면 서버를 늘리고 튜닝한다.
- 클라우드가 아닌 경우 장애가 발생하면 튜닝한다.

### WAS의 멀티 쓰레드 지원

- 멀티 쓰레드에 대한 부분은 WAS가 처리하낟.
- 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다.
- 개발자는 마치 싱글 쓰레드 프로그래밍 하듯이 편리하게 소스 코드를 개발
- 멀티 쓰레드 환경이므로 싱글톤 객체는 주의해서 사용한다.

# 정적 리소스

- 고정된 HTML 파일, CSS, JS, 이밎, 영상 등을 제공한다.
- 주로 웹 브라우저에서 요청한다.

# HTML 페이지

- 동적으로 필요한 HTML 파일을 생성해서 전달한다.
- 웹 브라우저는 HTML을 해석한다.

# HTTP API

- HTML이 아니라 데이터를 전달한다.
- 주로 JSON 형식을 사용한다.
- UI가 필요하다면 클라이언트가 별도로 처리한다.
- 앱 또는 웹 클라이언트가 요청하거나, 서버가 서버에게 요청한다.

# SSR, 서버 사이드 렌더링

- HTML 최종 결과를 서버에서 만들어서 웹 브라우저에 전달한다.
- 주로 정적인 화면에 사용한다.
- JSP, 타임리프

# CSR, 클라이언트 사이드 렌더링

- HTML 결과를 자바스크립트를 사용해 웹 브라우저에서 동적으로 생성해서 사용한다.
- 주로 동적인 화면에 사용한다.
    - 웹 환경을 앱처럼 필요한 부분 변경 가능
- 구글 지도, Gmail, 구글 캘린더
- React, Vue.js

> SSR을 사용하더도 자바스크립트를 사용해 화면 일부를 동적으로 변경 가능하다.

> React, Vue.js를 CSR과 SSR을 동시에 지원하는 웹 프레임워크도 있다.

# 자바 백엔드 웹 기술 역사

- 서블릿
    - HTML 생성이 어려움
- JSP
    - HTML 생성은 편리함
    - 화면 뿐 아니라 비즈니스 로직까지 담당 -> 너무 많은 역할
- 서블릿, JSP 조합 MVC 패턴 사용
    - 모델, 뷰, 컨트롤러로 역할을 나누어 개발
- MVC 프레임워크
    - MVC 패턴 자동화

## 현재 사용 기술

- 애노테이션 기반의 스프링 MVC 등장
    - `@Controller`
- 스프링 부트 등장
    - 스프링 부트는 서버를 내장
    - 과거에는 서버에 WAS를 직접 설치하고, 소스는 war파일을 만들어서 설치한 WAS에 배포
    - 스프링 부트는 빌드 결과(jar)에 WAS 서버가 포함되어 빌드, 배포가 단순하

## 최신기술 - 스프링 웹 플럭스 (Spring Web Flux)

### 특징

- 비동기 넌 블럭킹 처리
- 최소 쓰레드로 최대 성능 - 쓰레드 컨텍스트 스위칭 비용 효율화
- 함수형 스타일로 개발 - 동시 처리 코드 효율화
- 서블릿 기술을 사용하지 않음
- 기술적 난이도가 높음
- RDB 지원 부족
- 실무에서 많이 사용되지 않음

## 자바 뷰 템플릿 역사
- JSP
  - 속도 느림
  - 기능 부족
- Freemarker, Velocity
  - 속도 분제 해결
  - 다양한 기능 제공
- Thymeleaf
  - HTML 모양을 유지하면서 뷰 템플릿 적용이 가능하여 깔끔함
  - 스프링 MVC와 강력한 기능 통합 가능
  - 최선의 선택(성능은 프리마커, 벨로시티가 빠름)